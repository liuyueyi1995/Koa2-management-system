doctype html
html
  head
    meta(charset='utf-8')
    title= title
    link(rel='stylesheet' href='http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css')
    link(rel='stylesheet' href='/stylesheets/mycss.css')
    link(rel='stylesheet' href='//cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/build/css/bootstrap-datetimepicker.css')
    script(src='http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js')
    script(src='http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js')
    script(src='//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js')
    script(src='//cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/src/js/bootstrap-datetimepicker.js') 
    script.
      Handlebars.registerHelper('timestamps', function(timestamps){
        return new Date(timestamps).toString();
     });
    script#table-template(type="text/x-handlebars-template").
      {{#each roles}}
        <tr class="success">
          <td>{{id}}</td>
          <td>{{user_name}}</td>
          <td>{{study_name}}</td>
          <td>{{site_name}}</td>
          <td>{{type}}</td>
          <td>{{state}}</td>
          {{#if expiring_date}}
          <td>{{timestamps expiring_date}}</td>
          {{^}}
          <td></td>
          {{/if}}
          <td>{{timestamps created_at}}</td>
          <td>{{timestamps updated_at}}</td>
          <td><button class="btn btn-primary btn-xs btn-block btn-upd" type="button" data-toggle="modal" data-target="#update" data-result='{"id":{{id}},"user_name":"{{user_name}}","study_name":"{{study_name}}","site_name":"{{site_name}}","type":"{{type}}","state":"{{state}}","expiring_date":"{{expiring_date}}"}'>修改</button></td>
          <td><button class="btn btn-danger btn-xs btn-block btn-del" type="button" data-toggle="modal" data-target="#delete" data-id={{id}}>删除</button></td>
        </tr>
      {{/each}}
    script.
      $(function (){
        $(document).ready(function(){
          $('.btn-add').click(add); //搜索栏的添加按钮 触发ajax
          $('.btn-delete').click(del); //模态框里的删除按钮 触发ajax
          $('.btn-update').click(update); //模态框里的修改按钮 触发ajax
          $('.btn-search').click(search); //搜索栏的搜索按钮 利用css实现搜索
          $('body').on('click','.btn-upd',function() { //表格里的修改按钮 将该行的信息写入模态框
            let origin_info = $(this).attr("data-result");
            let info_obj = eval('('+origin_info+')'); //string to json
            $('#id_upd').val(info_obj.id);
            $('#user_upd').val(info_obj.user_name);
            $('#site_upd').val(info_obj.site_name);
            $('#study_upd').val(info_obj.study_name);
            $('#type_upd').val(info_obj.type);
            $('#state_upd').val(info_obj.state);
            $('#expiring_date_upd').val(info_obj.expiring_date);
          });
          $('body').on('click','.btn-del',function() { //表格里的删除按钮 将该行对应的id传递给模态框
            $('#del_confirm').html('确认删除 id = ' + $(this).attr("data-id")+' 的角色信息?');
            $('#del_id').html($(this).attr("data-id"));
          });
          $('body').on('click','#btn-ad',function() { //搜索框旁边的添加按钮 将所有已存在的用户信息传递给模态框
            let origin_user = $(this).attr("data-user");
            let user_obj = eval('('+origin_user+')'); //string to json
            let select_user = $('#user');
            select_user.html(""); //先清空下拉选项
            for(var item in user_obj){ //item是下标
              let option = $('<option value='+ user_obj[item].id +'>'+ user_obj[item].name+'</option>');
              option.appendTo(select_user); //添加节点
            } 
            let origin_study = $(this).attr("data-study");
            let study_obj = eval('('+origin_study+')'); //string to json
            let select_study = $('#study');
            select_study.html(""); //先清空下拉选项
            for(var item in study_obj){ //item是下标
              let option = $('<option value='+ study_obj[item].id +'>'+ study_obj[item].name+'</option>');
              option.appendTo(select_study); //添加节点
            }
          });
          $('#searchBox').bind('input propertychange',function() { //实时监听搜索框的内容，当内容变为空时，刷新页面
            if ($.trim($('#searchBox').val()) == '') {
              location.reload();
            }
          });
          $('body').on('change','#type',function(){ //级联下拉菜单，当选中的项目改变时，触发ajax修改机构信息
            let type = $(this).val();
            let id = $('#study').val();
            if (type == 'STUDY_ADMIN') {
              $('#site').val('').attr('disabled','true');
            } else {
              $('#site').removeAttr('disabled');
              $.ajax(
                {
                  url:'/role_manage',
                  data:{content:id,action:7},
                  type:"post",
                  beforeSend: function() {
                    $("#tips").html("<span style='color:blue'>正在处理...</span>");
                  },
                  success: function(result) {
                    if (result) {
                      let select_site = $('#site');
                      select_site.html(""); //先清空下拉选项
                      for(var item in result.sites){ //item是下标
                        let option = $('<option value='+ result.sites[item].id +'>'+ result.sites[item].name+'</option>');
                        option.appendTo(select_site); //添加节点
                      }
                    } else {
                      $("#tips").html("<span style='color:blue'>出现错误！</span>");
                    }
                  },
                  error: function() {
                    alert('请求出错');
                  },
                  complete: function() {
                    $('#tips').hide();
                  }
                }
              );
            }

          });
          $('body').on('click','.page',function() { 
            //处理分页请求，获取要跳转到的页码以及此时搜索框的内容，如果有内容，则返回搜索结果对应页的内容，如果搜索框为空，则返回全部结果对应页的内容
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            let page = $(this).attr("page");
            let search_content = $('#searchBox').val();
            let action = 0;
            if (page == 'first') {
              fetch_num = 1
            } else if (page == 'last') {
              fetch_num = $(this).attr("page_max")
            } else {
              fetch_num = $(this).attr("page")
            }
            if (search_content) {
              action = 5;
            }
            let content = {
              page: fetch_num,
              search_content: search_content
            }
            $.ajax(
              {
                url:'/role_manage',
                data:{content:content,action:action},
                type:"post",
                success: function(result) {
                  let tbody = $('tbody');
                  tbody.html("");
                  var tableTemplate = Handlebars.compile($("#table-template").html()); //使用handlebars模板完成数据的循环填充和变量插入
                  $("tbody").html(tableTemplate(result));
                }
              }
            );
          });
        });
      });
      function add() {
        let user = $('#user').val();
        let study = $('#study').val();
        let site = $('#site').val();
        let type = $('#type').val();
        let state = $('#state').val();
        let expiring_date = $('#expiring_date').val();
        if ($.trim(user) == '') {
          $('#warning1').text('用户为必填项！');
          return;
        } else {
          $('#warning1').text('');
        }
        if ($.trim(study) == '') {
          $('#warning2').text('项目名称为必填项！');
          return;
        } else {
          $('#warning2').text('');
        } 
        if ($.trim(type) == '') {
          $('#warning4').text('角色类型为必填项！');
          return;
        } else {
          $('#warning4').text('');
        }
        if ($.trim(state) == '') {
          $('#warning5').text('角色状态为必填项！');
          return;
        } else {
          $('#warning5').text('');
          let newRole = {
            "user":user,
            "study":study,
            "type":type,
            "state":state,
            "expiring_date":expiring_date
          };
          if (site) {
            newRole.site = site;
          }
          $.ajax(
            {
              url:'/role_manage',
              data:{content:newRole,action:2},
              type:"post",
              beforeSend: function() {
                $("#tips").html("<span style='color:blue'>正在处理...</span>");
              },
              success: function(result) {
                if (result) {
                  alert(result.ret);
                  location.reload();
                } else {
                  $("#tips").html("<span style='color:blue'>出现错误！</span>");
                }
              },
              error:function() {
                alert('请求出错');
              },
              complete:function() {
                $('#tips').hide();
              }
            }
          );
        } 
      }
      function del() {
        let id = $(this).parent().prev().html();
        $.ajax(
          {
            url:'/role_manage',
            data:{content:id,action:3},
            type:"post",
            beforeSend: function() {
              $("#tips1").html("<span style='color:blue'>正在处理...</span>");
            },
            success: function(result) {
              if (result) {
                alert(result.ret);
                location.reload();
              } else {
                $("#tips1").html("<span style='color:blue'>出现错误！</span>");
              }
            },
            error: function() {
              alert('请求出错');
            },
            complete: function() {
              $('#tips1').hide();
            }
          }
        );
      }
      function search() {
        let content = $.trim($('#searchBox').val());
        if (content) {
          $.post('/role_manage',{content:content,action:1},function(result){
            let length = result.len;
            if ($.isEmptyObject(result.roles)) { //如果没有查询到数据则返回提示
              alert(`
              No result matched the given condition!

              Please retry!`);
            } else { //如果查询到数据则动态生成表格               
              let tbody = $('tbody');
              tbody.html("");
              var tableTemplate = Handlebars.compile($("#table-template").html()); //使用handlebars模板完成数据的循环填充和变量插入
              $("tbody").html(tableTemplate(result));
              let page = $('#pagination');
              page.html("");
              $('<li class="page" page="first"><a>&laquo</a></li>').appendTo(page);
              for (var i = 1;i < result.page_num+1;i++) {
                $('<li class="page" page='+i+'><a>'+i+'</a></li>').appendTo(page);
              }
              $('<li class="page" page="last" page_max='+result.page_num+'><a>&raquo</a></li>').appendTo(page);
            }
          });
        } else {
          alert('There is no condition!');
        }
      } 
      function update() {
        let id = $('#id_upd').val();
        let state = $('#state_upd').val();
        let expiring_date = $('#expiring_date_upd').val();
        let newRole = {
          "id":id,
          "state":state,
          "expiring_date":expiring_date
        };
        console.log(newRole)
        $.ajax(
          {
            url:'/role_manage',
            data:{content:newRole,action:4},
            type:"post",
            beforeSend: function() {
              $("#tips").html("<span style='color:blue'>正在处理...</span>");
            },
            success: function(result) {
              if (result) {
                alert(result.ret);
                location.reload();
              } else {
                $("#tips").html("<span style='color:blue'>出现错误！</span>");
              }
            },
            error:function() {
              alert('请求出错');
            },
            complete:function() {
             $('#tips').hide();
            }
          }
        );
      }

  body
    div.container
      div.row
        ul.list-inline
          li.col-lg-3.nonpadding
            p.content-title=title
          li.col-lg-6.nonpadding
          li.float-right.col-lg-3.nonpadding
            div.input-group
              span.input-group-btn
                - var users = results.users,studies = results.studies
                button.btn.btn-warning#btn-ad(type='button',data-user=users,data-study=studies,data-toggle="modal",data-target="#add") 添加角色信息
              input#searchBox.form-control(type='text',placeholder='输入关键字，支持模糊查询',required)
              span.input-group-btn
                button.btn.btn-warning.btn-search(type='button') 搜索
            
      div.row
        table.table
          thead
            tr
              th 序号
              th 用户名称
              th 项目名称
              th 机构名称
              th 类型
              th 状态
              th 过期时间
              th 创建日期
              th 修改日期
              th 修改
              th 删除
          tbody
            each result in results.results
              tr
              each val in result
                td.success #{val}
              td.success 
                - var info = result
                button(type='button' class='btn btn-primary btn-xs btn-block btn-upd' data-result=info data-toggle="modal",data-target="#update") 修改
              td.success 
                - var id = result.id
                button(type='button' class='btn btn-danger btn-xs btn-block btn-del' data-id=id data-toggle="modal",data-target="#delete") 删除
      //分页组件
      div.row(style="text-align:center;")
        ul.pagination#pagination(style="margin:0 auto;")
          li.page(page="first")
            a &laquo;
          - for (var i = 1; i < results.page_num+1; i++)
            li.page(page=i): a #{i}
          li.page(page="last" page_max=results.page_num)
            a &raquo;
      //修改角色的模态框
      div.modal.fade#update(tabindex='-1',role='dialog',aria-labelledby='updLabel',aria-hidden='true')
        div.modal-dialog
          div.modal-content
            div.modal-header
              button.close(type='button' data-dismiss='modal' aria-hidden='true') &times;
              h4 修改角色信息
            div.modal-body 
              form.form-horizontal(role='form')
                div.form-group
                  label.col-sm-2.control-label 用户
                  div.col-sm-7
                    input.form-control#user_upd(type='text' disabled=true)
                  div.col-sm-3
                    p#warning6(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 项目
                  div.col-sm-7
                    input.form-control#study_upd(type='text' disabled=true)
                  div.col-sm-3
                    p#warning7(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 类型
                  div.col-sm-7
                    select.form-control#type_upd(disabled=true)
                      option(value='STUDY_ADMIN') STUDY_ADMIN
                      option(value='SITE_ADMIN') SITE_ADMIN
                      option(value='AUDITOR') AUDITOR
                      option(value='INPUTTER') INPUTTER
                  div.col-sm-3
                    p#warning9(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 机构
                  div.col-sm-7
                    input.form-control#site_upd(type='text' disabled=true)
                  div.col-sm-3
                    p#warning8(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 状态
                  div.col-sm-7
                    select.form-control#state_upd
                      option(value='ENABLE') ENABLE
                      option(value='DISABLE') DISABLE
                  div.col-sm-3
                    p#warning10(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 截止日期
                  div.col-sm-7
                    div.input-group.date#datetimepicker1
                      input.form-control#expiring_date_upd(type='text')
                      span.input-group-addon
                        span.glyphicon.glyphicon-calendar
                  script.
                    $(function() {
                      $('#datetimepicker1').datetimepicker({
                        format:"YYYY/MM/DD HH:MM"
                      });
                    });
                  div.col-sm-3
                    p#warning12(style='color:#ff0000')
            div#id_upd(style="display:none") 存储待修改项的id
            div.modal-footer
              button.btn.btn-default(type='button' data-dismiss='modal') 取消
              button.btn.btn-primary.btn-update(type='submit') 确认修改
            span#tips2
      //删除角色信息的模态框
      div.modal.fade#delete(tabindex='-1',role='dialog',aria-labelledby='delLabel',aria-hidden='true')
        div.modal-dialog
          div.modal-content
            div.modal-header
              button.close(type='button' data-dismiss='modal' aria-hidden='true') &times;
              h4 删除角色
            div.modal-body#del_confirm 确认删除？
            div#del_id(style="display:none") 存储待删除的id
            div.modal-footer
              button.btn.btn-default(type='button' data-dismiss='modal') 取消
              button.btn.btn-danger.btn-delete(type='submit') 确认删除
            span#tips1
      //添加角色信息的模态框
      div.modal.fade#add(tabindex='-1',role='dialog',aria-labelledby='addLabel',aria-hidden='true')
        div.modal-dialog
          div.modal-content
            div.modal-header
              button.close(type='button' data-dismiss='modal' aria-hidden='true') &times;
              h4 添加新角色
            div.modal-body 
              form.form-horizontal(role='form')
                div.form-group
                  label.col-sm-2.control-label 用户
                  div.col-sm-7
                    select.form-control#user
                  div.col-sm-3
                    p#warning1(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 项目
                  div.col-sm-7
                    select.form-control#study
                  div.col-sm-3
                    p#warning2(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 类型
                  div.col-sm-7
                    select.form-control#type
                      option(value='' selected) 请选择角色类型
                      option(value='STUDY_ADMIN') STUDY_ADMIN
                      option(value='SITE_ADMIN') SITE_ADMIN
                      option(value='AUDITOR') AUDITOR
                      option(value='INPUTTER') INPUTTER
                  div.col-sm-3
                    p#warning4(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 机构
                  div.col-sm-7
                    select.form-control#site
                  div.col-sm-3
                    p#warning3(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 状态
                  div.col-sm-7
                    select.form-control#state
                      option(value='ENABLE') ENABLE
                      option(value='DISABLE') DISABLE
                  div.col-sm-3
                    p#warning5(style='color:#ff0000')
                div.form-group
                  label.col-sm-2.control-label 截止日期
                  div.col-sm-7
                    div.input-group.date#datetimepicker
                      input.form-control#expiring_date(type='text')
                      span.input-group-addon
                        span.glyphicon.glyphicon-calendar
                  script.
                    $(function() {
                      $('#datetimepicker').datetimepicker({
                        format:"YYYY/MM/DD HH:MM"
                      });
                    });
                  div.col-sm-3
                    p#warning11(style='color:#ff0000')
            div.modal-footer
              button.btn.btn-default(type='button' data-dismiss='modal') 取消
              button.btn.btn-primary.btn-add(type='submit') 确认添加
            span#tips